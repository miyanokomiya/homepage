---
title: WebGL on Elm Architectureでレンダリングが重すぎるとき
date: '2020-04-01'
slug: elm-webgl-perform
categories:
  - teck
  - ElmでWebGL奮闘記
tags:
  - Elm
  - WebGL
thumbnailImage: /img/uploads/スクリーンショット-2020-04-01-23.21.53.png
---
modelにmeshを突っ込め。

<!--more-->

## 勘違い

Three.jsに甘えたWebGL利用しかしてこなかったせいか、WebGLという概念への根本的な理解が色々と足りていなかった。

まずはmeshという概念。基本的にmeshは三角形ポリゴンの集合によって表現される。ここまでは問題ない。問題だったのはmeshを移動・回転させるお作法。

解説用meshを自前で用意するのは非常に手間なのでこちらのThree.js製Webエディターに全力で頼っていく。 https://threejs.org/editor/

とりあえず何の変哲もないただの立方体にご登場いただく。

![](/img/uploads/スクリーンショット-2020-04-05-11.28.56.png)

次にこの立方体を回転させたいと考える。

![](/img/uploads/スクリーンショット-2020-04-05-11.28.27.png)

WebGLの気持ちをよく分かっていなった当初は、meshを回転させるには単純に「meshを構成する頂点をそれぞれ移動すればよい」とスーパーシンプルに考えてしまっていた。

もちろんこの方法でもmeshは回転した状態でWebGLは描画してくれる。しかしながらこのときの「回転した状態」というのは大きな語弊がある。正確に表現するなら、「元のmeshの頂点をそれぞれ回転させた頂点から新たに生成したmeshに差し替えた状態」といううことになる。要するに回転させる前と後のmeshは全く別の存在になってしまっている。

## mesh生成コスト

meshの生成には常にコストという問題が付き纏う。WebGLは確かに高速な3D描画機能を提供してくれる。しかし描画するためのmeshを生成するのはWebGLではなくスクリプト側である。

一度の回転だけならまだしも回転アニメーションを作ろうとすれば、毎フレームmeshを回転させなければいけない。もしmesh差し替え方式で回転を表現したら、毎フレームmeshの新規作成が行われるという贅沢すぎる状況となってしまう。

3D描画のパフォーマンス劣化を防ぐためにも、まず第一にmesh生成を最小限に抑える必要がある。

## カメラを動かす

mesh自体の頂点を回転させる方法がだめならどうやって回転を実現するか。meshが動かないならカメラを動かせばよい。

カメラを動かすとこうなる。

![](/img/uploads/スクリーンショット-2020-04-05-11.50.23.png)

meshは見事に回転した状態で描画された。そしてmesh自体は元のままなので再生成も行われていない。パフォーマンス劣化もない。めでたしめでたし。

当然ながら物事はそんなにシンプルではない。だってカメラ自体をを回転させたら3D空間全体が回転してしまうではないか。背景もなにも空間にただ1つのmeshを登場させるだけでいい状況なんて皆無ではないかというツッコミが溢れる。

しかしその考え自体が既にThree.js概念に引きずられていて、WebGL的概念に辿り着けていない。

[前回記事](/2020/03/elm-webgl-init/)でも触れたように、WebGLの世界に「カメラ」という概念は存在しない。

## WebGLとカメラ
WebGLの世界にカメラが存在していないのなら、3D空間を平面に描画しているこの視点の位置は一体なんなんだという疑問が当然出てくる。

結論から言うとそれはカメラではない。単にその位置から見えているように、それぞれのmeshを変形させた平面像をcanvasに描画しているに過ぎない。

この変形という役割を担っているのがShaderである。任意のmeshには任意のShaderによる変形を加えることができ、WebGLは変形後の3D表現をただの平面へと描画する。



